<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
</head>

<body>
<div class="search">
    <input type="text" id="serachContent"/>
    <input type="button" id="search" value="search"/>
    <span> Searchï¼š </span>
    <span id="result" style="color:red"> </span>
</div>
<div class="operate">
    <input type="text" id="addContent"/>
    <input type="button" id="add" value="Create"/>
    <br/>
    <br/>
    <textarea name="text" id="chat" style="height: 120px; width: 250px"></textarea>
    <button type="submit" id="submit">Send Transcript</button>
</div>
<ul class="list">

</ul>
</body>
<script type="text/javascript">
    var baseUrl = 'http://127.0.0.1:8081'

    // Search
    $('#search').click(function () {
        // HTTP requests will cause cross-domain problems under different ports of the machine. You need to add the @CrossOrigin annotation to the back-end controller class. See the back-end code for details.
        // ajax
        $.ajax({
            url: baseUrl + '/query',
            method: 'get',
            data: {
                'content': $('#serachContent').val()
            },
            success: function (data) {
                if (data.code == 500) {
                    alert(data.message)
                } else {
                    $('#result').text(data.data.content)
                }
            }
        })
    })

    // create
    $('#add').click(function () {
        $.ajax({
            url: baseUrl + '/create',
            method: 'post',
            contentType: "application/json", // Set the request header to JSON format
            data: JSON.stringify({'content': $('#addContent').val()}),
            success: function (data) {
                if (data.code == 500) {
                    alert(data.message)
                } else {
                    $('.list').empty()
                    queryAll()
                }
            }
        })
    })


    // queryAll();

    // query all
    function queryAll() {
        $.ajax({
            url: baseUrl + '/all',
            method: 'get',
            success: function (data) {
                if (data.code == 500) {
                    alert(data.message)
                } else {
                    let list = data.data;
                    list.forEach(item => {
                        $('.list').append('<li id="' + item.id + '"> <input type="text" id="updateContent" value=' + item.content + ' /> <input type="button" id="delete" value="delete"/> <input type="button" id="update" value="update"/> </li>')
                    });
                }
            }
        })
    }

    // update
    $('.list').on('click', '#update', function () {
        const id = $(this).parent().attr('id')
        $.ajax({
            url: baseUrl + '/update',
            method: 'post',
            contentType: "application/json", // Set the request header to JSON format
            data: JSON.stringify({'id': id, 'content': $('#updateContent').val()}),
            success: function (data) {
                if (data.code == 500) {
                    alert(data.message)
                } else {
                    console.log(data);
                }
            }
        })
    })

    // delete
    $('.list').on('click', '#delete', function () {
        const id = $(this).parent().attr('id')
        $.ajax({
            url: baseUrl + '/delete/' + id,
            method: 'get',
            success: function (data) {
                if (data.code == 500) {
                    alert(data.message)
                } else {
                    $('#' + id).remove()
                }
            }
        })
    })

    /***********************************************************/
    $("#submit").click((e) => {
        // e.preventDefault();
        let conversation = $("#chat").val();
        let newConversation = [];
        let msgArray = JSON.parse(conversation).messages;
        let sender;

        msgArray.find((item) => {
            if(item.sender_type.includes("User")) sender = item.sender_name;
        })

        msgArray.map((item) => {
            newConversation.push({[item.sender_name]: item.message});
        })
        // console.log(newConversation)

        let transcriptObj = {"agent_name": sender, "transcript": newConversation}
        console.log(JSON.stringify(transcriptObj))

        $.ajax({
            url: baseUrl + '/read_transcript',
            method: 'post',
            contentType: "application/json", // Set the request header to JSON format
            data: JSON.stringify(transcriptObj),
            success: function (data) {
                if (data.code == 500) {
                    alert(data.message)
                } else {
                    console.log('OK')
                }
            }
        })
    })
</script>

</html>